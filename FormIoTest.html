<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Form.io Renderer (BC iframe)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; font-family:Segoe UI, Roboto, Arial, sans-serif; background:#fff; color:#111; }
    #root { box-sizing:border-box; padding:12px; height:100%; display:flex; flex-direction:column; gap:12px; }
    #status { font-size:13px; color:#666; }
    #error { color:#b00020; font-weight:600; display:none; }
    #formio { flex:1; min-height:200px; border:1px solid #e6e6e6; padding:8px; overflow:auto; background:#fafafa; }
    pre { white-space:pre-wrap; word-break:break-word; background:#f5f5f5; padding:8px; border-radius:4px; }
    button { padding:8px 12px; border-radius:4px; border:1px solid #ccc; background:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <div id="root">
    <div id="status">Waiting for JSON from parent...</div>
    <div id="error" role="alert" aria-live="polite"></div>
    <div id="formio" aria-live="polite"></div>
    <div id="debug" style="display:none"><pre id="debugPre"></pre></div>
  </div>

  <script>
  (function () {
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const formContainer = document.getElementById('formio');
    const debugPre = document.getElementById('debugPre');

    function setStatus(t){ statusEl.textContent = t; }
    function showError(t){ errorEl.style.display=''; errorEl.textContent = t; }
    function debug(t){ debugPre.textContent += t + '\\n'; document.getElementById('debug').style.display=''; }

    // Load script helper (tries local first, then CDN)
    function loadScript(url){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=url; s.async=true;
        s.onload=()=>resolve(url);
        s.onerror=()=>reject(new Error('Failed to load '+url));
        document.head.appendChild(s);
      });
    }

    async function ensureFormio(){
      if (window.Formio) return;
      const candidates = [
        // Recommended: include a local copy in the same origin as this HTML (e.g., formio.full.min.js)
        '/formio.full.min.js',
        // Fallback CDN (may be blocked by CSP in some BC environments)
        'https://cdn.form.io/formiojs/formio.full.min.js'
      ];
      for (const url of candidates){
        try {
          await loadScript(url);
          if (window.Formio) return;
        } catch (e){
          debug('loadScript failed: ' + url + ' -> ' + e.message);
        }
      }
      throw new Error('Formio library not available. Add a local copy or allow CDN.');
    }

    // Render form JSON (string or object)
    async function renderForm(jsonText){
      formContainer.innerHTML=''; errorEl.style.display='none';
      setStatus('Parsing JSON...');
      let formJson;
      try {
        formJson = (typeof jsonText === 'string') ? JSON.parse(jsonText) : jsonText;
      } catch (e){
        showError('Invalid JSON: ' + e.message);
        return;
      }

      setStatus('Loading Formio library...');
      try {
        await ensureFormio();
      } catch (e){
        showError(e.message);
        return;
      }

      setStatus('Creating form...');
      try {
        Formio.createForm(formContainer, formJson)
          .then(form => {
            setStatus('Form rendered. Waiting for submit...');
            form.on('submit', submission => {
              try {
                const payload = JSON.stringify(submission.data);
                // Post submission back to parent
                if (window.parent && window.parent !== window) {
                  window.parent.postMessage({ type: 'MessageFromJs', message: payload }, '*');
                }
              } catch (err) {
                debug('submit error: ' + err.message);
              }
            });
          })
          .catch(err => {
            showError('Form.io createForm error: ' + (err && err.message ? err.message : String(err)));
          });
      } catch (err){
        showError('Render error: ' + err.message);
      }
    }

    // Message handler: accept JSON from parent (type "FromAL") or commands
    window.addEventListener('message', function (ev) {
      try {
        const data = ev && ev.data;
        if (!data) return;

        // If parent sends the JSON payload
        if (data.type === 'FromAL' && data.message) {
          setStatus('JSON received from parent. Rendering...');
          renderForm(data.message);
          return;
        }

        // Optional: direct render command
        if (data.type === 'render-json' && data.payload) {
          setStatus('Render command received.');
          renderForm(data.payload);
          return;
        }

        // Optional: enable debug
        if (data.type === 'debug' && data.payload === true) {
          document.getElementById('debug').style.display = '';
          return;
        }
      } catch (e) {
        debug('message handler error: ' + e.message);
      }
    }, false);

    // On load, notify parent that iframe is ready (so parent can send JSON)
    function notifyParentReady(){
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'iframe-ready' }, '*');
          setStatus('Ready. Waiting for JSON from parent...');
        } else {
          setStatus('No parent detected. Waiting for direct postMessage.');
        }
      } catch (e) {
        debug('notifyParentReady error: ' + e.message);
      }
    }

    // Expose direct API for debugging or direct calls
    window.__renderFormFromJson = renderForm;

    // Kick off
    setStatus('HTML loaded. Requesting JSON from parent...');
    setTimeout(notifyParentReady, 50);
  })();
  </script>
</body>
</html>
