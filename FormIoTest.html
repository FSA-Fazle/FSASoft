<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Form.io Renderer â€” Client Submit (fixed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; font-family:Segoe UI, Roboto, Arial, sans-serif; background:#fff; color:#111; }
    #root { box-sizing:border-box; padding:12px; height:100%; display:flex; flex-direction:column; gap:12px; }
    #status { font-size:13px; color:#666; }
    #error { color:#b00020; font-weight:600; display:none; }
    #formio { flex:1; min-height:200px; border:1px solid #e6e6e6; padding:8px; overflow:auto; background:#fafafa; }
    #controls { display:flex; gap:8px; align-items:center; }
    button { padding:8px 12px; border-radius:4px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    pre { white-space:pre-wrap; word-break:break-word; background:#f5f5f5; padding:8px; border-radius:4px; }
    #debug { display:none; max-height:200px; overflow:auto; }
  </style>
</head>
<body>
  <div id="root">
    <div id="status">Waiting for JSON from parent...</div>
    <div id="error" role="alert" aria-live="polite"></div>
    <div id="formio" aria-live="polite"></div>
    <div id="controls">
      <button id="manualSubmit" type="button" style="display:none">Submit</button>
      <div id="submitHint" style="color:#666;font-size:13px"></div>
    </div>
    <div id="debug"><pre id="debugPre"></pre></div>
  </div>

  <script>
  (function () {
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const formContainer = document.getElementById('formio');
    const debugPre = document.getElementById('debugPre');
    const debugBox = document.getElementById('debug');
    const manualSubmitBtn = document.getElementById('manualSubmit');
    const submitHint = document.getElementById('submitHint');

    function setStatus(t){ statusEl.textContent = t; }
    function showError(t){ errorEl.style.display=''; errorEl.textContent = t; }
    function debug(t){ debugBox.style.display=''; debugPre.textContent += t + '\n'; }

    // CONFIG: optional token or submission URL (kept for compatibility)
    const FORMIO_TOKEN = null;

    // Load script helper (CDN fallback)
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = () => resolve(url);
        s.onerror = () => reject(new Error('Failed to load ' + url));
        document.head.appendChild(s);
      });
    }

    async function ensureFormio() {
      if (window.Formio) return;
      const candidates = [
        'https://cdn.form.io/formiojs/formio.full.min.js'
      ];
      for (const url of candidates) {
        try {
          await loadScript(url);
          if (window.Formio) return;
        } catch (e) {
          debug('loadScript failed: ' + url + ' -> ' + e.message);
        }
      }
      throw new Error('Formio library not available. Add a local copy or allow CDN.');
    }

    // Post messages to parent safely
    function postToParent(obj) {
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage(obj, '*');
        }
      } catch (e) {
        debug('postToParent error: ' + e.message);
      }
    }

    // Intercept Formio.makeRequest for submission endpoints and forward to parent
    // This prevents cross-origin XHR from inside an iframe and lets the parent handle the network call.
    function interceptFormioRequests() {
      if (!window.Formio || !Formio.makeRequest) return;
      const originalMakeRequest = Formio.makeRequest.bind(Formio);

      Formio.makeRequest = function(type, url, data, opts) {
        try {
          // Intercept POST submissions to endpoints that include '/submission'
          if (type && type.toLowerCase() === 'post' && url && url.toLowerCase().includes('/submission')) {
            debug('Intercepting Form.io submission to: ' + url);
            return new Promise((resolve, reject) => {
              const id = 'formio-' + Date.now() + '-' + Math.random().toString(36).slice(2);
              let timedOut = false;

              function handler(ev) {
                try {
                  const d = ev && ev.data;
                  if (!d || d.type !== 'formio-response' || d.id !== id) return;
                  window.removeEventListener('message', handler);
                  if (timedOut) return;
                  if (d.success) resolve(d.payload);
                  else reject(d.error || new Error('Submission failed in parent'));
                } catch (e) {
                  window.removeEventListener('message', handler);
                  reject(e);
                }
              }

              window.addEventListener('message', handler);

              // Send submission to parent for handling
              postToParent({ type: 'formio-submit', id: id, url: url, data: data });

              // Timeout fallback
              const timeout = setTimeout(() => {
                timedOut = true;
                window.removeEventListener('message', handler);
                reject(new Error('Submission timed out (no response from parent)'));
              }, 30000);

              // Note: handler will clear timeout when resolving/rejecting
            });
          }
        } catch (e) {
          debug('makeRequest intercept error: ' + e.message);
        }
        // Fallback to original behavior for all other requests
        return originalMakeRequest(type, url, data, opts);
      };
    }

    // Render form JSON and use Form.io built-in client submit (network calls intercepted)
    async function renderFormFromJson(jsonText) {
      formContainer.innerHTML = '';
      errorEl.style.display = 'none';
      setStatus('Parsing JSON...');
      let formJson;
      try {
        formJson = typeof jsonText === 'string' ? JSON.parse(jsonText) : jsonText;
      } catch (e) {
        showError('Invalid JSON: ' + e.message);
        return;
      }

      setStatus('Loading Formio library...');
      try {
        await ensureFormio();
      } catch (e) {
        showError(e.message);
        return;
      }

      // Intercept network calls before creating the form
      interceptFormioRequests();

      setStatus('Creating form...');
      try {
        Formio.createForm(formContainer, formJson)
          .then(form => {
            setStatus('Form rendered. Wiring submit...');

            // If the form requires a token for remote submit, set it here
            if (FORMIO_TOKEN && typeof Formio.setToken === 'function') {
              Formio.setToken(FORMIO_TOKEN);
            }

            // Defensive: also post submission to parent on submit event (keeps UI responsive)
            form.on('submit', function(submission) {
              try {
                postToParent({ type: 'MessageFromJs', message: submission.data });
              } catch (e) {
                debug('postMessage submit error: ' + e.message);
              }
            });

            // When Form.io completes its normal remote save, capture the result
            form.on('submitDone', (submission) => {
              debug('submitDone event: ' + JSON.stringify(submission.data || {}));
              postToParent({ type: 'formio-submission-success', payload: submission });
            });

            // Capture submit errors
            form.on('submitError', (err) => {
              debug('submitError event: ' + (err && err.message ? err.message : JSON.stringify(err)));
              postToParent({ type: 'formio-submission-failed', error: String(err) });
              showError('Submit error: ' + (err && err.message ? err.message : String(err)));
            });

            // Defensive: if Form.io's submit button is not usable in this environment,
            // attach a manual submit control that calls form.submit()
            setTimeout(() => {
              try {
                const btn = formContainer.querySelector('button[type="submit"], button[data-component="submit"]');
                if (btn) {
                  debug('Found native submit button; no manual control needed.');
                  manualSubmitBtn.style.display = 'none';
                } else {
                  debug('Native submit button not found; showing manual submit control.');
                  manualSubmitBtn.style.display = '';
                  submitHint.textContent = 'Click Submit to send data to Form.io server (parent will handle network).';
                  manualSubmitBtn.onclick = () => {
                    setStatus('Submitting (manual)...');
                    form.submit()
                      .then(result => {
                        setStatus('Submission completed.');
                        postToParent({ type: 'formio-submission-success', payload: result });
                      })
                      .catch(err => {
                        setStatus('Submission failed.');
                        showError('Submit error: ' + (err && err.message ? err.message : String(err)));
                        postToParent({ type: 'formio-submission-failed', error: String(err) });
                      });
                  };
                }
              } catch (ex) {
                debug('defensive submit handler error: ' + ex.message);
              }
            }, 200);

            setStatus('Form ready. Fill and submit.');
          })
          .catch(err => {
            showError('Form.io createForm error: ' + (err && err.message ? err.message : String(err)));
          });
      } catch (err) {
        showError('Render error: ' + err.message);
      }
    }

    // Message handler: accept JSON from parent (type "FromAL") or commands
    window.addEventListener('message', function (ev) {
      try {
        const data = ev && ev.data;
        if (!data) return;

        if (data.type === 'FromAL' && data.message) {
          setStatus('JSON received from parent. Rendering...');
          renderFormFromJson(data.message);
          return;
        }

        if (data.type === 'render-json' && data.payload) {
          setStatus('Render command received.');
          renderFormFromJson(data.payload);
          return;
        }

        if (data.type === 'debug' && data.payload === true) {
          debugBox.style.display = '';
          return;
        }

        // Parent can respond to our intercepted submission with a 'formio-response' message
        // Example parent response format:
        // { type: 'formio-response', id: '<id>', success: true, payload: { ... } }
        // or { type: 'formio-response', id: '<id>', success: false, error: '...' }
      } catch (e) {
        debug('message handler error: ' + e.message);
      }
    }, false);

    // Notify parent that iframe is ready
    function notifyParentReady() {
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'iframe-ready' }, '*');
          setStatus('Ready. Waiting for JSON from parent...');
        } else {
          setStatus('No parent detected. Waiting for direct postMessage.');
        }
      } catch (e) {
        debug('notifyParentReady error: ' + e.message);
      }
    }

    // Expose API for debugging
    window.__renderFormFromJson = renderFormFromJson;

    // Global error handlers to capture issues inside iframe
    window.addEventListener('error', function(e) {
      try { debug('Global error: ' + e.message + ' @ ' + e.filename + ':' + e.lineno); } catch (ex) {}
    });
    window.addEventListener('unhandledrejection', function(e) {
      try { debug('Unhandled rejection: ' + (e.reason && e.reason.message ? e.reason.message : JSON.stringify(e.reason))); } catch (ex) {}
    });

    // Start
    setStatus('HTML loaded. Requesting JSON from parent...');
    setTimeout(notifyParentReady, 50);
  })();
  </script>
</body>
</html>
